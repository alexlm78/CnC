<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/main :: layout(~{::content})}">
<head>
	<title>Catalog List</title>
</head>
<body>
<div th:fragment="content">
	<h1>Catalog Management</h1>

	<div class="filter-panel">
		<form id="filterForm" th:action="@{/catalogs}" method="get" th:object="${filter}">
			<!-- Filters Row with Search Button -->
			<div class="row g-3 align-items-end">
				<div class="col-md-3">
					<label class="form-label">Module</label>
					<select id="moduloSelect" class="form-select filter-select" th:field="*{modulo}">
						<option value="">All Modules</option>
						<option th:each="modulo : ${modulos}"
								th:value="${modulo}"
								th:text="${modulo}"></option>
					</select>
				</div>
				<div class="col-md-3">
					<label class="form-label">Field (CAMPO)</label>
					<select id="campoSelect" class="form-select filter-select" th:field="*{campo}">
						<option value="">All Fields</option>
						<option th:each="campo : ${campos}"
								th:value="${campo}"
								th:text="${campo}"
								th:attr="data-modulo='all'"></option>
					</select>
				</div>
				<div class="col-md-2">
					<label class="form-label">CADENA</label>
					<select id="sbsNoSelect" class="form-select filter-select" th:field="*{sbsNo}">
						<option value="1">GNC</option>
						<option value="2">Arca</option>
					</select>
				</div>
				<div class="col-md-2">
					<label class="form-label">Has Conversion</label>
					<select id="hasConversionSelect" class="form-select filter-select" th:field="*{hasConversion}">
						<option value="">All</option>
						<option value="true">Yes</option>
						<option value="false">No</option>
					</select>
				</div>
				<div class="col-md-2 d-flex align-items-end">
					<!-- Search Toggle Button -->
					<button type="button" id="searchToggleBtn" class="btn btn-outline-primary"
							th:classappend="${filter.searchTerm != null && !filter.searchTerm.isEmpty()} ? 'active' : ''"
							title="Search">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
							<path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
						</svg>
						<span th:if="${filter.searchTerm != null && !filter.searchTerm.isEmpty()}" class="badge bg-primary ms-1">1</span>
					</button>
				</div>
			</div>

			<!-- Expandable Search Box -->
			<div id="searchContainer" class="mt-3"
				 th:style="${filter.searchTerm != null && !filter.searchTerm.isEmpty()} ? 'display: block;' : 'display: none;'">
				<div class="input-group">
					<span class="input-group-text bg-white">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
							<path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
						</svg>
					</span>
					<input type="text"
						   id="searchInput"
						   class="form-control"
						   th:field="*{searchTerm}"
						   placeholder="Search in module, field, value, description..."
						   autocomplete="off">
					<button type="button" id="clearSearchBtn" class="btn btn-outline-secondary"
							th:classappend="${filter.searchTerm == null || filter.searchTerm.isEmpty()} ? 'd-none' : ''">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
							<path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
						</svg>
					</button>
				</div>
			</div>

			<div class="mt-3">
				<a th:href="@{/catalogs}" class="btn btn-secondary">Clear Filters</a>
			</div>
		</form>
	</div>

	<div class="card">
		<div class="card-body">
			<div class="d-flex justify-content-between align-items-center mb-3">
				<h5 class="card-title mb-0">
					Catalog Items (<span th:text="${catalogPage.totalElements}">0</span>)
				</h5>
				<div class="d-flex align-items-center">
					<label for="pageSizeSelect" class="me-2 mb-0">Records per page:</label>
					<select id="pageSizeSelect" class="form-select form-select-sm" style="width: auto;" th:attr="data-current-size=${pageSize}">
						<option value="10" th:selected="${pageSize == 10}">10</option>
						<option value="25" th:selected="${pageSize == 25}">25</option>
						<option value="50" th:selected="${pageSize == 50}">50</option>
					</select>
				</div>
			</div>

			<div class="table-responsive">
				<table class="table table-striped table-hover">
					<thead>
					<tr>
						<th>Cadena</th>
						<th>Modulo</th>
						<th>Campo</th>
						<th>Valor</th>
						<th>Descripcion</th>
						<th>Conversion</th>
						<th>Actiones</th>
					</tr>
					</thead>
					<tbody>
					<tr th:each="item : ${catalogs}">
						<td th:text="${item.cadenaDisplay}"></td>
						<td th:text="${item.modulo}"></td>
						<td th:text="${item.campo}"></td>
						<td th:text="${item.valor}"></td>
						<td th:text="${item.descripcion}"></td>
						<td>
								<span th:if="${item.hasConversion}"
									  class="badge bg-success conversion-badge"
									  th:text="${item.conversionDomain}">Domain</span>
							<span th:unless="${item.hasConversion}"
								  class="badge bg-secondary conversion-badge">None</span>
						</td>
						<td>
							<div class="btn-group btn-group-sm" role="group">
								<a th:if="${!item.hasConversion}"
								   th:href="@{/conversions/new(modulo=${item.modulo},campo=${item.campo},valor=${item.valor},cadena=${item.sbsNo},returnModulo=${filter.modulo},returnCampo=${filter.campo},returnSbsNo=${filter.sbsNo},returnHasConversion=${filter.hasConversion},returnPage=${currentPage},returnSize=${pageSize},returnSearchTerm=${filter.searchTerm})}"
								   class="btn btn-primary btn-sm"
								   title="Add Conversion">
									Add
								</a>
								<a th:if="${item.hasConversion}"
								   th:href="@{/conversions/view(modulo=${item.modulo},campo=${item.campo},valor=${item.valor},cadena=${item.sbsNo},returnModulo=${filter.modulo},returnCampo=${filter.campo},returnSbsNo=${filter.sbsNo},returnHasConversion=${filter.hasConversion},returnPage=${currentPage},returnSize=${pageSize},returnSearchTerm=${filter.searchTerm})}"
								   class="btn btn-info btn-sm"
								   title="View Conversion">
									View
								</a>
								<a th:if="${item.hasConversion}"
								   th:href="@{/conversions/edit(modulo=${item.modulo},campo=${item.campo},valor=${item.valor},cadena=${item.sbsNo},returnModulo=${filter.modulo},returnCampo=${filter.campo},returnSbsNo=${filter.sbsNo},returnHasConversion=${filter.hasConversion},returnPage=${currentPage},returnSize=${pageSize},returnSearchTerm=${filter.searchTerm})}"
								   class="btn btn-warning btn-sm"
								   title="Edit Conversion">
									Edit
								</a>
							</div>
						</td>
					</tr>
					<tr th:if="${#lists.isEmpty(catalogs)}">
						<td colspan="7" class="text-center">No catalog items found</td>
					</tr>
					</tbody>
				</table>
			</div>

			<!-- Pagination Controls -->
			<div class="d-flex justify-content-between align-items-center mt-3">
				<div>
					<span th:if="${catalogPage.totalElements > 0}">
						Showing <span th:text="${catalogPage.number * catalogPage.size + 1}">1</span>
						to <span th:text="${(catalogPage.number * catalogPage.size + catalogPage.numberOfElements)}">10</span>
						of <span th:text="${catalogPage.totalElements}">100</span> records
					</span>
					<span th:if="${catalogPage.totalElements == 0}">No records found</span>
				</div>
				<nav th:if="${catalogPage.totalPages > 1}">
					<ul class="pagination mb-0">
						<!-- First Page -->
						<li class="page-item" th:classappend="${catalogPage.first} ? 'disabled'">
							<a class="page-link" th:href="@{/catalogs(page=0,size=${pageSize},modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}" aria-label="First">
								<span aria-hidden="true">&laquo;&laquo;</span>
							</a>
						</li>

						<!-- Previous Page -->
						<li class="page-item" th:classappend="${catalogPage.first} ? 'disabled'">
							<a class="page-link" th:href="@{/catalogs(page=${catalogPage.number - 1},size=${pageSize},modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}" aria-label="Previous">
								<span aria-hidden="true">&laquo;</span>
							</a>
						</li>

						<!-- Page Numbers -->
						<li class="page-item"
							th:each="pageNum : ${#numbers.sequence(0, catalogPage.totalPages - 1)}"
							th:if="${pageNum >= (catalogPage.number - 2) && pageNum <= (catalogPage.number + 2)}"
							th:classappend="${pageNum == catalogPage.number} ? 'active'">
							<a class="page-link" th:href="@{/catalogs(page=${pageNum},size=${pageSize},modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}" th:text="${pageNum + 1}">1</a>
						</li>

						<!-- Next Page -->
						<li class="page-item" th:classappend="${catalogPage.last} ? 'disabled'">
							<a class="page-link" th:href="@{/catalogs(page=${catalogPage.number + 1},size=${pageSize},modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}" aria-label="Next">
								<span aria-hidden="true">&raquo;</span>
							</a>
						</li>

						<!-- Last Page -->
						<li class="page-item" th:classappend="${catalogPage.last} ? 'disabled'">
							<a class="page-link" th:href="@{/catalogs(page=${catalogPage.totalPages - 1},size=${pageSize},modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}" aria-label="Last">
								<span aria-hidden="true">&raquo;&raquo;</span>
							</a>
						</li>
					</ul>
				</nav>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
		// Module-Campo mapping from server
		const moduloCamposMap = /*[[${moduloCamposMap}]]*/ {};
		const allCampos = /*[[${campos}]]*/ [];

		// Get references to selects and form
		const filterForm = document.getElementById('filterForm');
		const moduloSelect = document.getElementById('moduloSelect');
		const campoSelect = document.getElementById('campoSelect');
		const sbsNoSelect = document.getElementById('sbsNoSelect');
		const hasConversionSelect = document.getElementById('hasConversionSelect');
		const pageSizeSelect = document.getElementById('pageSizeSelect');
		const searchInput = document.getElementById('searchInput');
		const clearSearchBtn = document.getElementById('clearSearchBtn');
		const searchToggleBtn = document.getElementById('searchToggleBtn');
		const searchContainer = document.getElementById('searchContainer');

		// Current pagination state
		const currentPage = /*[[${currentPage}]]*/ 0;
		const currentSize = /*[[${pageSize}]]*/ 10;

		// Flag to prevent double submission
		let isSubmitting = false;

		// Debounce timer for search
		let searchDebounceTimer = null;

		// Search box visibility state
		let searchVisible = searchContainer.style.display !== 'none';

		// Function to update campo options based on selected modulo
		function updateCampoOptions() {
			const selectedModulo = moduloSelect.value;
			const currentCampo = campoSelect.value;

			// Clear current options except "All Fields"
			campoSelect.innerHTML = '<option value="">All Fields</option>';

			let camposToShow = [];

			if (selectedModulo === '' || selectedModulo === null) {
				// Show all campos sorted
				camposToShow = allCampos;
			} else {
				// Show only campos for selected modulo
				camposToShow = moduloCamposMap[selectedModulo] || [];
			}

			// Add options
			camposToShow.forEach(campo => {
				const option = document.createElement('option');
				option.value = campo;
				option.textContent = campo;
				if (campo === currentCampo) {
					option.selected = true;
				}
				campoSelect.appendChild(option);
			});
		}

		// Function to auto-submit form
		function autoSubmitForm() {
			if (!isSubmitting) {
				isSubmitting = true;
				filterForm.submit();
			}
		}

		// Add event listener to modulo select
		moduloSelect.addEventListener('change', function() {
			updateCampoOptions();
			autoSubmitForm();
		});

		// Add event listeners to other filters for auto-submit
		campoSelect.addEventListener('change', autoSubmitForm);
		sbsNoSelect.addEventListener('change', autoSubmitForm);
		hasConversionSelect.addEventListener('change', autoSubmitForm);

		// Add event listener for page size change
		pageSizeSelect.addEventListener('change', function() {
			const newSize = pageSizeSelect.value;
			const currentUrl = new URL(window.location.href);
			currentUrl.searchParams.set('size', newSize);
			currentUrl.searchParams.set('page', '0'); // Reset to first page when changing size
			window.location.href = currentUrl.toString();
		});

		// Add event listener for search input with debounce
		searchInput.addEventListener('input', function() {
			// Show/hide clear button
			if (searchInput.value.trim() !== '') {
				clearSearchBtn.classList.remove('d-none');
			} else {
				clearSearchBtn.classList.add('d-none');
			}

			// Debounce search - wait 500ms after user stops typing
			clearTimeout(searchDebounceTimer);
			searchDebounceTimer = setTimeout(function() {
				autoSubmitForm();
			}, 500);
		});

		// Add event listener for Enter key in search input
		searchInput.addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				e.preventDefault();
				clearTimeout(searchDebounceTimer);
				autoSubmitForm();
			}
		});

		// Add event listener for clear search button
		clearSearchBtn.addEventListener('click', function() {
			searchInput.value = '';
			clearSearchBtn.classList.add('d-none');
			searchToggleBtn.classList.remove('active');
			// Remove badge
			const badge = searchToggleBtn.querySelector('.badge');
			if (badge) badge.remove();
			autoSubmitForm();
		});

		// Add event listener for search toggle button
		searchToggleBtn.addEventListener('click', function() {
			searchVisible = !searchVisible;
			if (searchVisible) {
				searchContainer.style.display = 'block';
				searchInput.focus();
			} else {
				searchContainer.style.display = 'none';
			}
		});

		// Initialize on page load
		updateCampoOptions();
	</script>
</div>
</body>
</html>
