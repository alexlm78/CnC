<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/main :: layout(~{::content})}">
<head>
	<title>Catalog List</title>
</head>
<body>
<div th:fragment="content">
	<h1>Catalog Management</h1>

	<div class="filter-panel">
		<form id="filterForm" th:action="@{/catalogs}" method="get" th:object="${filter}">
			<!-- Filters Row with Search Button -->
			<div class="row g-3 align-items-end">
				<div class="col-md-3">
					<label class="form-label">Module</label>
					<select id="moduloSelect" class="form-select filter-select" th:field="*{modulo}">
						<option value="">All Modules</option>
						<option th:each="modulo : ${modulos}"
								th:value="${modulo}"
								th:text="${modulo}"></option>
					</select>
				</div>
				<div class="col-md-3">
					<label class="form-label">Field (CAMPO)</label>
					<select id="campoSelect" class="form-select filter-select" th:field="*{campo}">
						<option value="">All Fields</option>
						<option th:each="campo : ${campos}"
								th:value="${campo}"
								th:text="${campo}"
								th:attr="data-modulo='all'"></option>
					</select>
				</div>
				<div class="col-md-2">
					<label class="form-label">CADENA</label>
					<select id="sbsNoSelect" class="form-select filter-select" th:field="*{sbsNo}">
						<option value="1">GNC</option>
						<option value="2">Arca</option>
					</select>
				</div>
				<div class="col-md-2">
					<label class="form-label">Has Conversion</label>
					<select id="hasConversionSelect" class="form-select filter-select" th:field="*{hasConversion}">
						<option value="">All</option>
						<option value="true">Yes</option>
						<option value="false">No</option>
					</select>
				</div>
				<div class="col-md-2 d-flex align-items-end">
					<!-- Search Toggle Button -->
					<button type="button" id="searchToggleBtn" class="btn btn-outline-primary"
							th:classappend="${filter.searchTerm != null && !filter.searchTerm.isEmpty()} ? 'active' : ''"
							title="Search">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
							<path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
						</svg>
						<span th:if="${filter.searchTerm != null && !filter.searchTerm.isEmpty()}" class="badge bg-primary ms-1">1</span>
					</button>
				</div>
			</div>

			<!-- Expandable Search Box -->
			<div id="searchContainer" class="mt-3"
				 th:style="${filter.searchTerm != null && !filter.searchTerm.isEmpty()} ? 'display: block;' : 'display: none;'">
				<div class="input-group">
					<span class="input-group-text bg-white">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
							<path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
						</svg>
					</span>
					<input type="text"
						   id="searchInput"
						   class="form-control"
						   th:field="*{searchTerm}"
						   placeholder="Search in module, field, value, description..."
						   autocomplete="off">
					<button type="button" id="clearSearchBtn" class="btn btn-outline-secondary"
							th:classappend="${filter.searchTerm == null || filter.searchTerm.isEmpty()} ? 'd-none' : ''">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
							<path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
						</svg>
					</button>
				</div>
			</div>

			<div class="mt-3">
				<a th:href="@{/catalogs}" class="btn btn-secondary">Clear Filters</a>
			</div>
		</form>
	</div>

	<div class="card">
		<div class="card-body">
			<div class="d-flex justify-content-between align-items-center mb-3">
				<h5 class="card-title mb-0">
					Catalog Items (<span th:text="${catalogPage.totalElements}">0</span>)
				</h5>
				<div class="d-flex align-items-center gap-2">
					<!-- Export Dropdown -->
					<div class="dropdown">
						<button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download me-1" viewBox="0 0 16 16">
								<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
								<path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
							</svg>
							Export
						</button>
						<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
							<li><h6 class="dropdown-header">Full Catalog</h6></li>
							<li>
								<a class="dropdown-item" th:href="@{/export-import/export/csv(modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}">
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-csv me-2" viewBox="0 0 16 16">
										<path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5L14 4.5ZM3.517 14.841a1.13 1.13 0 0 0 .401.823c.13.108.289.192.478.252.19.061.411.091.665.091.338 0 .624-.053.859-.158.236-.105.416-.252.539-.44.125-.189.187-.408.187-.656 0-.224-.045-.41-.134-.56a1.001 1.001 0 0 0-.375-.357 2.027 2.027 0 0 0-.566-.21l-.621-.144a.97.97 0 0 1-.404-.176.37.37 0 0 1-.144-.299c0-.156.062-.284.185-.384.125-.101.296-.152.512-.152.143 0 .266.023.37.068a.624.624 0 0 1 .246.181.56.56 0 0 1 .12.258h.75a1.092 1.092 0 0 0-.2-.566 1.21 1.21 0 0 0-.5-.41 1.813 1.813 0 0 0-.78-.152c-.293 0-.551.05-.776.15-.225.099-.4.24-.527.421-.127.182-.19.395-.19.639 0 .201.04.376.122.524.082.149.2.27.352.367.152.095.332.167.539.213l.618.144c.207.049.361.113.463.193a.387.387 0 0 1 .152.326.505.505 0 0 1-.085.29.559.559 0 0 1-.255.193c-.111.047-.249.07-.413.07-.117 0-.223-.013-.32-.04a.838.838 0 0 1-.248-.115.578.578 0 0 1-.255-.384h-.765ZM.806 13.693c0-.248.034-.46.102-.633a.868.868 0 0 1 .302-.399.814.814 0 0 1 .475-.137c.15 0 .283.032.398.097a.7.7 0 0 1 .272.26.85.85 0 0 1 .12.381h.765v-.072a1.33 1.33 0 0 0-.466-.964 1.441 1.441 0 0 0-.489-.272 1.838 1.838 0 0 0-.606-.097c-.356 0-.66.074-.911.223-.25.148-.44.359-.572.632-.13.274-.196.6-.196.979v.498c0 .379.064.704.193.976.131.271.322.48.572.626.25.145.554.217.914.217.293 0 .554-.055.785-.164.23-.11.414-.26.55-.454a1.27 1.27 0 0 0 .226-.674v-.076h-.764a.799.799 0 0 1-.118.363.7.7 0 0 1-.272.25.874.874 0 0 1-.401.087.845.845 0 0 1-.478-.132.833.833 0 0 1-.299-.392 1.699 1.699 0 0 1-.102-.627v-.495Zm8.239 2.238h-.953l-1.338-3.999h.917l.896 3.138h.038l.888-3.138h.879l-1.327 4Z"/>
									</svg>
									Export to CSV
								</a>
							</li>
							<li>
								<a class="dropdown-item" th:href="@{/export-import/export/excel(modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}">
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel me-2" viewBox="0 0 16 16">
										<path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
										<path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
									</svg>
									Export to Excel
								</a>
							</li>
							<li><hr class="dropdown-divider"></li>
							<li><h6 class="dropdown-header">Conversions Template</h6></li>
							<li>
								<a class="dropdown-item" th:href="@{/export-import/export/conversions/csv(modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}">
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-csv me-2" viewBox="0 0 16 16">
										<path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2h-1v-1h1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5L14 4.5ZM3.517 14.841a1.13 1.13 0 0 0 .401.823c.13.108.289.192.478.252.19.061.411.091.665.091.338 0 .624-.053.859-.158.236-.105.416-.252.539-.44.125-.189.187-.408.187-.656 0-.224-.045-.41-.134-.56a1.001 1.001 0 0 0-.375-.357 2.027 2.027 0 0 0-.566-.21l-.621-.144a.97.97 0 0 1-.404-.176.37.37 0 0 1-.144-.299c0-.156.062-.284.185-.384.125-.101.296-.152.512-.152.143 0 .266.023.37.068a.624.624 0 0 1 .246.181.56.56 0 0 1 .12.258h.75a1.092 1.092 0 0 0-.2-.566 1.21 1.21 0 0 0-.5-.41 1.813 1.813 0 0 0-.78-.152c-.293 0-.551.05-.776.15-.225.099-.4.24-.527.421-.127.182-.19.395-.19.639 0 .201.04.376.122.524.082.149.2.27.352.367.152.095.332.167.539.213l.618.144c.207.049.361.113.463.193a.387.387 0 0 1 .152.326.505.505 0 0 1-.085.29.559.559 0 0 1-.255.193c-.111.047-.249.07-.413.07-.117 0-.223-.013-.32-.04a.838.838 0 0 1-.248-.115.578.578 0 0 1-.255-.384h-.765ZM.806 13.693c0-.248.034-.46.102-.633a.868.868 0 0 1 .302-.399.814.814 0 0 1 .475-.137c.15 0 .283.032.398.097a.7.7 0 0 1 .272.26.85.85 0 0 1 .12.381h.765v-.072a1.33 1.33 0 0 0-.466-.964 1.441 1.441 0 0 0-.489-.272 1.838 1.838 0 0 0-.606-.097c-.356 0-.66.074-.911.223-.25.148-.44.359-.572.632-.13.274-.196.6-.196.979v.498c0 .379.064.704.193.976.131.271.322.48.572.626.25.145.554.217.914.217.293 0 .554-.055.785-.164.23-.11.414-.26.55-.454a1.27 1.27 0 0 0 .226-.674v-.076h-.764a.799.799 0 0 1-.118.363.7.7 0 0 1-.272.25.874.874 0 0 1-.401.087.845.845 0 0 1-.478-.132.833.833 0 0 1-.299-.392 1.699 1.699 0 0 1-.102-.627v-.495Zm8.239 2.238h-.953l-1.338-3.999h.917l.896 3.138h.038l.888-3.138h.879l-1.327 4Z"/>
									</svg>
									CSV Template
								</a>
							</li>
							<li>
								<a class="dropdown-item" th:href="@{/export-import/export/conversions/excel(modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}">
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-excel me-2" viewBox="0 0 16 16">
										<path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
										<path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
									</svg>
									Excel Template
								</a>
							</li>
						</ul>
					</div>

					<!-- Import Button -->
					<button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#importModal">
						<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16">
							<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
							<path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
						</svg>
						Import
					</button>

					<span class="border-start ps-2 ms-1"></span>

					<label for="pageSizeSelect" class="me-2 mb-0">Records per page:</label>
					<select id="pageSizeSelect" class="form-select form-select-sm" style="width: auto;" th:attr="data-current-size=${pageSize}">
						<option value="10" th:selected="${pageSize == 10}">10</option>
						<option value="25" th:selected="${pageSize == 25}">25</option>
						<option value="50" th:selected="${pageSize == 50}">50</option>
					</select>
				</div>
			</div>

			<!-- Import Errors Alert -->
			<div th:if="${importErrors != null && !importErrors.isEmpty()}" class="alert alert-warning alert-dismissible fade show" role="alert">
				<strong>Import Warnings:</strong>
				<ul class="mb-0 mt-2">
					<li th:each="error : ${importErrors}" th:text="${error}"></li>
				</ul>
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>

			<div class="table-responsive">
				<table class="table table-striped table-hover">
					<thead>
					<tr>
						<th>Cadena</th>
						<th>Modulo</th>
						<th>Campo</th>
						<th>Valor</th>
						<th>Descripcion</th>
						<th>Conversion</th>
						<th>Actiones</th>
					</tr>
					</thead>
					<tbody>
					<tr th:each="item : ${catalogs}">
						<td th:text="${item.cadenaDisplay}"></td>
						<td th:text="${item.modulo}"></td>
						<td th:text="${item.campo}"></td>
						<td th:text="${item.valor}"></td>
						<td th:text="${item.descripcion}"></td>
						<td>
								<span th:if="${item.hasConversion}"
									  class="badge bg-success conversion-badge"
									  th:text="${item.conversionDomain}">Domain</span>
							<span th:unless="${item.hasConversion}"
								  class="badge bg-secondary conversion-badge">None</span>
						</td>
						<td>
							<div class="btn-group btn-group-sm" role="group">
								<a th:if="${!item.hasConversion}"
								   th:href="@{/conversions/new(modulo=${item.modulo},campo=${item.campo},valor=${item.valor},cadena=${item.sbsNo},returnModulo=${filter.modulo},returnCampo=${filter.campo},returnSbsNo=${filter.sbsNo},returnHasConversion=${filter.hasConversion},returnPage=${currentPage},returnSize=${pageSize},returnSearchTerm=${filter.searchTerm})}"
								   class="btn btn-primary btn-sm"
								   title="Add Conversion">
									Add
								</a>
								<a th:if="${item.hasConversion}"
								   th:href="@{/conversions/view(modulo=${item.modulo},campo=${item.campo},valor=${item.valor},cadena=${item.sbsNo},returnModulo=${filter.modulo},returnCampo=${filter.campo},returnSbsNo=${filter.sbsNo},returnHasConversion=${filter.hasConversion},returnPage=${currentPage},returnSize=${pageSize},returnSearchTerm=${filter.searchTerm})}"
								   class="btn btn-info btn-sm"
								   title="View Conversion">
									View
								</a>
								<a th:if="${item.hasConversion}"
								   th:href="@{/conversions/edit(modulo=${item.modulo},campo=${item.campo},valor=${item.valor},cadena=${item.sbsNo},returnModulo=${filter.modulo},returnCampo=${filter.campo},returnSbsNo=${filter.sbsNo},returnHasConversion=${filter.hasConversion},returnPage=${currentPage},returnSize=${pageSize},returnSearchTerm=${filter.searchTerm})}"
								   class="btn btn-warning btn-sm"
								   title="Edit Conversion">
									Edit
								</a>
							</div>
						</td>
					</tr>
					<tr th:if="${#lists.isEmpty(catalogs)}">
						<td colspan="7" class="text-center">No catalog items found</td>
					</tr>
					</tbody>
				</table>
			</div>

			<!-- Pagination Controls -->
			<div class="d-flex justify-content-between align-items-center mt-3">
				<div>
					<span th:if="${catalogPage.totalElements > 0}">
						Showing <span th:text="${catalogPage.number * catalogPage.size + 1}">1</span>
						to <span th:text="${(catalogPage.number * catalogPage.size + catalogPage.numberOfElements)}">10</span>
						of <span th:text="${catalogPage.totalElements}">100</span> records
					</span>
					<span th:if="${catalogPage.totalElements == 0}">No records found</span>
				</div>
				<nav th:if="${catalogPage.totalPages > 1}">
					<ul class="pagination mb-0">
						<!-- First Page -->
						<li class="page-item" th:classappend="${catalogPage.first} ? 'disabled'">
							<a class="page-link" th:href="@{/catalogs(page=0,size=${pageSize},modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}" aria-label="First">
								<span aria-hidden="true">&laquo;&laquo;</span>
							</a>
						</li>

						<!-- Previous Page -->
						<li class="page-item" th:classappend="${catalogPage.first} ? 'disabled'">
							<a class="page-link" th:href="@{/catalogs(page=${catalogPage.number - 1},size=${pageSize},modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}" aria-label="Previous">
								<span aria-hidden="true">&laquo;</span>
							</a>
						</li>

						<!-- Page Numbers -->
						<li class="page-item"
							th:each="pageNum : ${#numbers.sequence(0, catalogPage.totalPages - 1)}"
							th:if="${pageNum >= (catalogPage.number - 2) && pageNum <= (catalogPage.number + 2)}"
							th:classappend="${pageNum == catalogPage.number} ? 'active'">
							<a class="page-link" th:href="@{/catalogs(page=${pageNum},size=${pageSize},modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}" th:text="${pageNum + 1}">1</a>
						</li>

						<!-- Next Page -->
						<li class="page-item" th:classappend="${catalogPage.last} ? 'disabled'">
							<a class="page-link" th:href="@{/catalogs(page=${catalogPage.number + 1},size=${pageSize},modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}" aria-label="Next">
								<span aria-hidden="true">&raquo;</span>
							</a>
						</li>

						<!-- Last Page -->
						<li class="page-item" th:classappend="${catalogPage.last} ? 'disabled'">
							<a class="page-link" th:href="@{/catalogs(page=${catalogPage.totalPages - 1},size=${pageSize},modulo=${filter.modulo},campo=${filter.campo},sbsNo=${filter.sbsNo},hasConversion=${filter.hasConversion},searchTerm=${filter.searchTerm})}" aria-label="Last">
								<span aria-hidden="true">&raquo;&raquo;</span>
							</a>
						</li>
					</ul>
				</nav>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
		// Module-Campo mapping from server
		const moduloCamposMap = /*[[${moduloCamposMap}]]*/ {};
		const allCampos = /*[[${campos}]]*/ [];

		// Get references to selects and form
		const filterForm = document.getElementById('filterForm');
		const moduloSelect = document.getElementById('moduloSelect');
		const campoSelect = document.getElementById('campoSelect');
		const sbsNoSelect = document.getElementById('sbsNoSelect');
		const hasConversionSelect = document.getElementById('hasConversionSelect');
		const pageSizeSelect = document.getElementById('pageSizeSelect');
		const searchInput = document.getElementById('searchInput');
		const clearSearchBtn = document.getElementById('clearSearchBtn');
		const searchToggleBtn = document.getElementById('searchToggleBtn');
		const searchContainer = document.getElementById('searchContainer');

		// Current pagination state
		const currentPage = /*[[${currentPage}]]*/ 0;
		const currentSize = /*[[${pageSize}]]*/ 10;

		// Flag to prevent double submission
		let isSubmitting = false;

		// Debounce timer for search
		let searchDebounceTimer = null;

		// Search box visibility state
		let searchVisible = searchContainer.style.display !== 'none';

		// Function to update campo options based on selected modulo
		function updateCampoOptions() {
			const selectedModulo = moduloSelect.value;
			const currentCampo = campoSelect.value;

			// Clear current options except "All Fields"
			campoSelect.innerHTML = '<option value="">All Fields</option>';

			let camposToShow = [];

			if (selectedModulo === '' || selectedModulo === null) {
				// Show all campos sorted
				camposToShow = allCampos;
			} else {
				// Show only campos for selected modulo
				camposToShow = moduloCamposMap[selectedModulo] || [];
			}

			// Add options
			camposToShow.forEach(campo => {
				const option = document.createElement('option');
				option.value = campo;
				option.textContent = campo;
				if (campo === currentCampo) {
					option.selected = true;
				}
				campoSelect.appendChild(option);
			});
		}

		// Function to auto-submit form
		function autoSubmitForm() {
			if (!isSubmitting) {
				isSubmitting = true;
				filterForm.submit();
			}
		}

		// Add event listener to modulo select
		moduloSelect.addEventListener('change', function() {
			updateCampoOptions();
			autoSubmitForm();
		});

		// Add event listeners to other filters for auto-submit
		campoSelect.addEventListener('change', autoSubmitForm);
		sbsNoSelect.addEventListener('change', autoSubmitForm);
		hasConversionSelect.addEventListener('change', autoSubmitForm);

		// Add event listener for page size change
		pageSizeSelect.addEventListener('change', function() {
			const newSize = pageSizeSelect.value;
			const currentUrl = new URL(window.location.href);
			currentUrl.searchParams.set('size', newSize);
			currentUrl.searchParams.set('page', '0'); // Reset to first page when changing size
			window.location.href = currentUrl.toString();
		});

		// Add event listener for search input with debounce
		searchInput.addEventListener('input', function() {
			// Show/hide clear button
			if (searchInput.value.trim() !== '') {
				clearSearchBtn.classList.remove('d-none');
			} else {
				clearSearchBtn.classList.add('d-none');
			}

			// Debounce search - wait 500ms after user stops typing
			clearTimeout(searchDebounceTimer);
			searchDebounceTimer = setTimeout(function() {
				autoSubmitForm();
			}, 500);
		});

		// Add event listener for Enter key in search input
		searchInput.addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				e.preventDefault();
				clearTimeout(searchDebounceTimer);
				autoSubmitForm();
			}
		});

		// Add event listener for clear search button
		clearSearchBtn.addEventListener('click', function() {
			searchInput.value = '';
			clearSearchBtn.classList.add('d-none');
			searchToggleBtn.classList.remove('active');
			// Remove badge
			const badge = searchToggleBtn.querySelector('.badge');
			if (badge) badge.remove();
			autoSubmitForm();
		});

		// Add event listener for search toggle button
		searchToggleBtn.addEventListener('click', function() {
			searchVisible = !searchVisible;
			if (searchVisible) {
				searchContainer.style.display = 'block';
				searchInput.focus();
			} else {
				searchContainer.style.display = 'none';
			}
		});

		// Initialize on page load
		updateCampoOptions();
	</script>

	<!-- Import Modal -->
	<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="importModalLabel">
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-upload me-2" viewBox="0 0 16 16">
							<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
							<path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
						</svg>
						Import Conversions
					</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<form th:action="@{/export-import/import}" method="post" enctype="multipart/form-data">
					<div class="modal-body">
						<div class="mb-3">
							<label for="importFile" class="form-label">Select File (CSV or Excel)</label>
							<input type="file" class="form-control" id="importFile" name="file" accept=".csv,.xlsx,.xls" required>
							<div class="form-text">
								Supported formats: CSV (.csv), Excel (.xlsx, .xls)
							</div>
						</div>

						<div class="alert alert-info">
							<strong>File Format:</strong>
							<p class="mb-1 mt-2">The file must contain the following columns:</p>
							<ol class="mb-0 ps-3">
								<li><strong>Modulo</strong> - Module name (required)</li>
								<li><strong>Campo</strong> - Field name (required)</li>
								<li><strong>Valor</strong> - Value (required)</li>
								<li><strong>Cadena</strong> - Chain/SBS_NO (required, 1 or 2)</li>
								<li><strong>Domain</strong> - Domain value (optional)</li>
								<li><strong>Status</strong> - Status (optional, default 1)</li>
							</ol>
							<hr>
							<small>
								<strong>Tip:</strong> Use "Export > Conversions Template" to download a template file with the correct format.
							</small>
						</div>

						<!-- Hidden fields to preserve filters -->
						<input type="hidden" name="returnModulo" th:value="${filter.modulo}">
						<input type="hidden" name="returnCampo" th:value="${filter.campo}">
						<input type="hidden" name="returnSbsNo" th:value="${filter.sbsNo}">
						<input type="hidden" name="returnHasConversion" th:value="${filter.hasConversion}">
						<input type="hidden" name="returnPage" th:value="${currentPage}">
						<input type="hidden" name="returnSize" th:value="${pageSize}">
						<input type="hidden" name="returnSearchTerm" th:value="${filter.searchTerm}">
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
						<button type="submit" class="btn btn-primary">
							<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16">
								<path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
								<path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
							</svg>
							Import
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
</body>
</html>
